# SwiftLint Configuration for PETL Stability Rules

disabled_rules:
  - trailing_whitespace
  - line_length

opt_in_rules:
  - empty_count
  - force_unwrapping
  - implicitly_unwrapped_optional
  - overridden_super_call
  - redundant_nil_coalescing
  - sorted_imports
  - vertical_parameter_alignment_on_call

# Custom rules to prevent stability regressions
custom_rules:
  ban_insertPower_outside_manager:
    included: ["PETL"]
    name: "insertPower only from BatteryTrackingManager"
    regex: 'insertPower\('
    match_kinds: [identifier]
    excluded: ["BatteryTrackingManager.swift", ".*Tests\\.swift"]
    severity: error
    message: "insertPower() may only be called from BatteryTrackingManager. Use BatteryTrackingManager.persistPowerSample instead."

  ban_powerDBDidChange_subscribers_outside_parent:
    included: ["PETL"]
    name: "powerDBDidChange subscriptions only in parent VM"
    regex: 'powerDBDidChange'
    excluded: ["ContentView.swift", ".*ChartsVM.*\\.swift", ".*Tests\\.swift"]
    severity: error
    message: "Subscribing to .powerDBDidChange is only allowed in ChartsVM/ContentView parent."

  power_chart_must_be_bars:
    included: ["ChargingPowerBarsChart.swift"]
    name: "Power chart must use bars"
    regex: 'LineMark'
    severity: error
    message: "Power chart must use bars (BarMark), not lines (LineMark)"

  battery_chart_must_not_be_bars:
    included: ["SimpleBatteryChart.swift"]
    name: "Battery chart must not use bars"
    regex: 'BarMark'
    severity: error
    message: "Battery chart must not use bars (BarMark), use LineMark + AreaMark instead"

  ban_direct_chargeDB_access:
    included: ["PETL"]
    name: "Direct ChargeDB.shared access only in BatteryTrackingManager"
    regex: 'ChargeDB\.shared'
    excluded: ["BatteryTrackingManager.swift", ".*Tests\\.swift"]
    severity: error
    message: "Direct ChargeDB.shared access only allowed in BatteryTrackingManager"

  require_stability_fences:
    included: ["PETL"]
    name: "Stability-locked code must have fences"
    regex: 'STABILITY-LOCKED'
    severity: warning
    message: "Stability-locked code should be fenced with BEGIN/END STABILITY-LOCKED comments"

  ban_seeded_start_outside_manager:
    included: "PETL/.*\\.swift"
    excluded: "PETL/LiveActivityManager.swift"
    name: "Use wrapper start"
    regex: "startActivity\\(seed:"
    message: "Call startActivity(reason:) wrapper only."
    severity: error

  ban_local_unplug_endall:
    name: "No direct endAll(local unplug)"
    regex: "endAll\\([^)]*local unplug"
    message: "Unplug must end via endActive(...)."
    severity: error

  require_critical_starter_log:
    name: "ðŸŽ¬ must use addToAppLogsCritical"
    regex: "Started Live Activity id=.*(Logger\\.|laLogger)"
    message: "Use addToAppLogsCritical for ðŸŽ¬ logs."
    severity: error

  # SSOT: Battery data must come from ChargeStateStore
  ban_uidevice_battery_outside_manager:
    name: "Battery SSOT"
    regex: "UIDevice\\.current\\.battery(Level|State)"
    excluded: "PETL/BatteryTrackingManager.swift"
    message: "Read battery level/state only in BatteryTrackingManager; consume ChargeStateStore.snapshot."
    severity: error

  # SSOT: ETA must come from snapshot
  ban_timeToFull_direct_ui:
    name: "ETA from SSOT"
    regex: "timeToFullMinutes|lastStableMinutes|theoreticalMinutesToFull"
    excluded: "PETL/BatteryTrackingManager.swift"
    message: "ETA must be composed into ChargingSnapshot; UI must read snapshot.etaMinutes."
    severity: error

  # SSOT: Live Activity must use mapper
  ban_live_activity_inline_mapping:
    name: "Use SnapshotToLiveActivity"
    regex: "ContentState\\("
    excluded: "PETL/SnapshotToLiveActivity.swift"
    message: "Build ContentState only via SnapshotToLiveActivity.makeContent(from:)."
    severity: error

# General code quality rules
line_length:
  warning: 120
  error: 150

function_body_length:
  warning: 50
  error: 100

type_body_length:
  warning: 300
  error: 500

file_length:
  warning: 500
  error: 1000

cyclomatic_complexity:
  warning: 10
  error: 20
